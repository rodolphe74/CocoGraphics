CC=cmoc
RM=rm -rf
ASTYLE=astyle
# SAPFS=sapfs.exe	-> Thomson MOTO conversion ?
IMGTOOL=imgtool.exe		# -> WARNING windows version, use it under WSL (or find linux version.)
AWK=awk
CAT=cat
CP=cp
XROAR=xroar.exe -machine coco3 -tv-input rgb -kbd-translate -ram 128K


# replaceAndRun target use following 2 vars
# (use convert to convert an image to coc format before)
IMAGE_PREFIX = bn
IMAGE_CHUNKS = 4

# do not modify
IMAGE_FILENAME_LEN =  $(shell $(AWK) 'BEGIN{print length("$(IMAGE_PREFIX)")}')
IMAGE_CHUNK_PREFIX_FILENAME_LOWER = $(shell printf %-8s%s $(IMAGE_PREFIX) CO)
IMAGE_CHUNK_PREFIX_FILENAME = $(shell $(AWK) 'BEGIN{print toupper("$(IMAGE_CHUNK_PREFIX_FILENAME_LOWER)")}')
IMAGE_PAL_FILENAME_LOWER = $(shell printf %-8s%s $(IMAGE_PREFIX) PAL)
IMAGE_PAL_FILENAME = $(shell $(AWK) 'BEGIN{print toupper("$(IMAGE_PAL_FILENAME_LOWER)")}')
$(info $(IMAGE_PREFIX))
$(info $(IMAGE_CHUNK_PREFIX_FILENAME))
$(info $(IMAGE_PAL_FILENAME))


CFLAGS= -O2 --coco -DCMOC_COMPILER -DDRIVER_ENTRY=0xC000 --org=4000
LDFLAGS= -lcmoc-crt-dgn -lcmoc-float-dgn 


all: pixel

replaceAndCompile:
	# replace first three lines of pixel.c with image parameters
	$(RM) _pixel.c
	$(CAT) ./pixel.awk | $(AWK) 'NR==1 { sub("@@@@@@@@@@", "$(IMAGE_CHUNK_PREFIX_FILENAME)") };{print}' > temp.c
	$(CP) temp.c _pixel.c
	$(CAT) ./_pixel.c | $(AWK) 'NR==2 { sub("@@@@@@@@@@@", "$(IMAGE_PAL_FILENAME)") };{print}' > temp.c
	$(CP) temp.c _pixel.c
	$(CAT) ./_pixel.c | $(AWK) 'NR==3 { sub("@", "$(IMAGE_CHUNKS)") };{print}' > temp.c
	$(CP) temp.c _pixel.c
	$(CC) $(CFLAGS) -opixel.bin _pixel.c $(LDFLAGS)
	$(RM) temp.c


pixel: pixel.c
	$(CC) $(CFLAGS) -o$@.bin  $^ $(LDFLAGS)
#	$(CC) -S $(CFLAGS)  $^

floppy: pixel
	$(IMGTOOL) create coco_jvc_rsdos floppy.dsk
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk P.BAS P.BAS --ftype=basic --ascii=binary --filter=cocobas
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk pixel.bin pixel.bin

	### images copy ###
	# $(IMGTOOL) put coco_jvc_rsdos floppy.dsk arton525.coc arton525.coc
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk arton525.pal arton525.pal
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk arton525.co0 arton525.co0
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk arton525.co1 arton525.co1
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk arton525.co2 arton525.co2
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk arton525.co3 arton525.co3

	# $(IMGTOOL) put coco_jvc_rsdos floppy.dsk badm.coc badm.coc
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk badm.pal badm.pal
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk badm.co0 badm.co0
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk badm.co1 badm.co1
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk badm.co2 badm.co2
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk badm.co3 badm.co3

	# $(IMGTOOL) put coco_jvc_rsdos floppy.dsk bn.coc bn.coc
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk bn.pal bn.pal
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk bn.co0 bn.co0
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk bn.co1 bn.co1
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk bn.co2 bn.co2
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk bn.co3 bn.co3

	# $(IMGTOOL) put coco_jvc_rsdos floppy.dsk oss.coc oss.coc
	# $(IMGTOOL) put coco_jvc_rsdos floppy.dsk oss.pal oss.pal
	# $(IMGTOOL) put coco_jvc_rsdos floppy.dsk oss.co0 oss.co0
	# $(IMGTOOL) put coco_jvc_rsdos floppy.dsk oss.co1 oss.co1
	# $(IMGTOOL) put coco_jvc_rsdos floppy.dsk oss.co2 oss.co2
	# $(IMGTOOL) put coco_jvc_rsdos floppy.dsk oss.co3 oss.co3
	### end of images copy ###

	$(IMGTOOL) dir coco_jvc_rsdos floppy.dsk

run: clean pixel floppy
	$(XROAR) -load-fd0 floppy.dsk

replaceAndRun:clean replaceAndCompile
	$(IMGTOOL) create coco_jvc_rsdos floppy.dsk
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk P.BAS P.BAS --ftype=basic --ascii=binary --filter=cocobas
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk pixel.bin pixel.bin
	### images copy ###
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk $(IMAGE_PREFIX).pal $(IMAGE_PREFIX).pal
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk $(IMAGE_PREFIX).co0 $(IMAGE_PREFIX).co0
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk $(IMAGE_PREFIX).co1 $(IMAGE_PREFIX).co1
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk $(IMAGE_PREFIX).co2 $(IMAGE_PREFIX).co2
	$(IMGTOOL) put coco_jvc_rsdos floppy.dsk $(IMAGE_PREFIX).co3 $(IMAGE_PREFIX).co3
	$(XROAR) -load-fd0 floppy.dsk

format:
	$(ASTYLE) --style=linux ray.c --pad-oper --pad-comma *.c *.h
	$(RM) *.orig

clean:
	$(RM) *.o *.a *.bin
